<?xml version="1.0" ?>
<template encoding-version="1.0">
  <description></description>
  <groupId>d2383382-0158-1000-ee23-b6354df67804</groupId>
  <name>python_traceroute</name>
  <snippet>
    <connections>
      <id>fd92a65a-0158-1000-0000-000000000000</id>
      <parentGroupId>d2383382-0158-1000-0000-000000000000</parentGroupId>
      <backPressureDataSizeThreshold>1 GB</backPressureDataSizeThreshold>
      <backPressureObjectThreshold>10000</backPressureObjectThreshold>
      <bends>
        <x>757.5613527153037</x>
        <y>276.94895083329163</y>
      </bends>
      <bends>
        <x>757.5613527153037</x>
        <y>326.94895083329163</y>
      </bends>
      <destination>
        <groupId>d2383382-0158-1000-0000-000000000000</groupId>
        <id>44023d4c-0157-1000-0000-000000000000</id>
        <type>PROCESSOR</type>
      </destination>
      <flowFileExpiration>0 sec</flowFileExpiration>
      <labelIndex>1</labelIndex>
      <name></name>
      <selectedRelationships>failure</selectedRelationships>
      <source>
        <groupId>d2383382-0158-1000-0000-000000000000</groupId>
        <id>44023d4c-0157-1000-0000-000000000000</id>
        <type>PROCESSOR</type>
      </source>
      <zIndex>0</zIndex>
    </connections>
    <connections>
      <id>fdae48cf-0158-1000-0000-000000000000</id>
      <parentGroupId>d2383382-0158-1000-0000-000000000000</parentGroupId>
      <backPressureDataSizeThreshold>1 GB</backPressureDataSizeThreshold>
      <backPressureObjectThreshold>10000</backPressureObjectThreshold>
      <bends>
        <x>1136.2415074245873</x>
        <y>44.2344441998041</y>
      </bends>
      <bends>
        <x>1136.2415074245873</x>
        <y>94.2344441998041</y>
      </bends>
      <destination>
        <groupId>d2383382-0158-1000-0000-000000000000</groupId>
        <id>fdae26be-0158-1000-0000-000000000000</id>
        <type>PROCESSOR</type>
      </destination>
      <flowFileExpiration>0 sec</flowFileExpiration>
      <labelIndex>1</labelIndex>
      <name></name>
      <selectedRelationships>failure</selectedRelationships>
      <source>
        <groupId>d2383382-0158-1000-0000-000000000000</groupId>
        <id>fdae26be-0158-1000-0000-000000000000</id>
        <type>PROCESSOR</type>
      </source>
      <zIndex>0</zIndex>
    </connections>
    <connections>
      <id>fdc0b26a-0158-1000-0000-000000000000</id>
      <parentGroupId>d2383382-0158-1000-0000-000000000000</parentGroupId>
      <backPressureDataSizeThreshold>1 GB</backPressureDataSizeThreshold>
      <backPressureObjectThreshold>10000</backPressureObjectThreshold>
      <destination>
        <groupId>d2383382-0158-1000-0000-000000000000</groupId>
        <id>44023d4c-0157-1000-0000-000000000000</id>
        <type>PROCESSOR</type>
      </destination>
      <flowFileExpiration>0 sec</flowFileExpiration>
      <labelIndex>1</labelIndex>
      <name></name>
      <selectedRelationships>success</selectedRelationships>
      <source>
        <groupId>d2383382-0158-1000-0000-000000000000</groupId>
        <id>fd8b1a1a-0158-1000-0000-000000000000</id>
        <type>PROCESSOR</type>
      </source>
      <zIndex>0</zIndex>
    </connections>
    <connections>
      <id>01571004-3d4c-1402-0000-000000000000</id>
      <parentGroupId>d2383382-0158-1000-0000-000000000000</parentGroupId>
      <backPressureDataSizeThreshold>1 GB</backPressureDataSizeThreshold>
      <backPressureObjectThreshold>10000</backPressureObjectThreshold>
      <destination>
        <groupId>d2383382-0158-1000-0000-000000000000</groupId>
        <id>fdae26be-0158-1000-0000-000000000000</id>
        <type>PROCESSOR</type>
      </destination>
      <flowFileExpiration>0 sec</flowFileExpiration>
      <labelIndex>1</labelIndex>
      <name></name>
      <selectedRelationships>success</selectedRelationships>
      <source>
        <groupId>d2383382-0158-1000-0000-000000000000</groupId>
        <id>44023d4c-0157-1000-0000-000000000000</id>
        <type>PROCESSOR</type>
      </source>
      <zIndex>0</zIndex>
    </connections>
    <processors>
      <id>fd8b1a1a-0158-1000-0000-000000000000</id>
      <parentGroupId>d2383382-0158-1000-0000-000000000000</parentGroupId>
      <position>
        <x>0.0</x>
        <y>0.0</y>
      </position>
      <config>
        <bulletinLevel>WARN</bulletinLevel>
        <comments></comments>
        <concurrentlySchedulableTaskCount>1</concurrentlySchedulableTaskCount>
        <descriptors>
          <entry>
            <key>File Size</key>
            <value>
              <name>File Size</name>
            </value>
          </entry>
          <entry>
            <key>Batch Size</key>
            <value>
              <name>Batch Size</name>
            </value>
          </entry>
          <entry>
            <key>Data Format</key>
            <value>
              <name>Data Format</name>
            </value>
          </entry>
          <entry>
            <key>Unique FlowFiles</key>
            <value>
              <name>Unique FlowFiles</name>
            </value>
          </entry>
          <entry>
            <key>generate-ff-custom-text</key>
            <value>
              <name>generate-ff-custom-text</name>
            </value>
          </entry>
        </descriptors>
        <executionNode>ALL</executionNode>
        <lossTolerant>false</lossTolerant>
        <penaltyDuration>30 sec</penaltyDuration>
        <properties>
          <entry>
            <key>File Size</key>
            <value>0B</value>
          </entry>
          <entry>
            <key>Batch Size</key>
            <value>1</value>
          </entry>
          <entry>
            <key>Data Format</key>
            <value>Text</value>
          </entry>
          <entry>
            <key>Unique FlowFiles</key>
            <value>false</value>
          </entry>
          <entry>
            <key>generate-ff-custom-text</key>
            <value>{
    "hosts" : [
        {"host" : "google.com"}
    ]
}</value>
          </entry>
        </properties>
        <runDurationMillis>0</runDurationMillis>
        <schedulingPeriod>45 sec</schedulingPeriod>
        <schedulingStrategy>TIMER_DRIVEN</schedulingStrategy>
        <yieldDuration>1 sec</yieldDuration>
      </config>
      <name>GenerateFlowFile</name>
      <relationships>
        <autoTerminate>false</autoTerminate>
        <name>success</name>
      </relationships>
      <style></style>
      <type>org.apache.nifi.processors.standard.GenerateFlowFile</type>
    </processors>
    <processors>
      <id>fdae26be-0158-1000-0000-000000000000</id>
      <parentGroupId>d2383382-0158-1000-0000-000000000000</parentGroupId>
      <position>
        <x>681.2415074245873</x>
        <y>4.234444199804102</y>
      </position>
      <config>
        <bulletinLevel>WARN</bulletinLevel>
        <comments></comments>
        <concurrentlySchedulableTaskCount>1</concurrentlySchedulableTaskCount>
        <descriptors>
          <entry>
            <key>Directory</key>
            <value>
              <name>Directory</name>
            </value>
          </entry>
          <entry>
            <key>Conflict Resolution Strategy</key>
            <value>
              <name>Conflict Resolution Strategy</name>
            </value>
          </entry>
          <entry>
            <key>Create Missing Directories</key>
            <value>
              <name>Create Missing Directories</name>
            </value>
          </entry>
          <entry>
            <key>Maximum File Count</key>
            <value>
              <name>Maximum File Count</name>
            </value>
          </entry>
          <entry>
            <key>Last Modified Time</key>
            <value>
              <name>Last Modified Time</name>
            </value>
          </entry>
          <entry>
            <key>Permissions</key>
            <value>
              <name>Permissions</name>
            </value>
          </entry>
          <entry>
            <key>Owner</key>
            <value>
              <name>Owner</name>
            </value>
          </entry>
          <entry>
            <key>Group</key>
            <value>
              <name>Group</name>
            </value>
          </entry>
        </descriptors>
        <executionNode>ALL</executionNode>
        <lossTolerant>false</lossTolerant>
        <penaltyDuration>30 sec</penaltyDuration>
        <properties>
          <entry>
            <key>Directory</key>
            <value>/tmp/traceroute_output</value>
          </entry>
          <entry>
            <key>Conflict Resolution Strategy</key>
            <value>fail</value>
          </entry>
          <entry>
            <key>Create Missing Directories</key>
            <value>true</value>
          </entry>
          <entry>
            <key>Maximum File Count</key>
          </entry>
          <entry>
            <key>Last Modified Time</key>
          </entry>
          <entry>
            <key>Permissions</key>
          </entry>
          <entry>
            <key>Owner</key>
          </entry>
          <entry>
            <key>Group</key>
          </entry>
        </properties>
        <runDurationMillis>0</runDurationMillis>
        <schedulingPeriod>0 sec</schedulingPeriod>
        <schedulingStrategy>TIMER_DRIVEN</schedulingStrategy>
        <yieldDuration>1 sec</yieldDuration>
      </config>
      <name>PutFile</name>
      <relationships>
        <autoTerminate>false</autoTerminate>
        <name>failure</name>
      </relationships>
      <relationships>
        <autoTerminate>true</autoTerminate>
        <name>success</name>
      </relationships>
      <style></style>
      <type>org.apache.nifi.processors.standard.PutFile</type>
    </processors>
    <processors>
      <id>01571000-3d4c-1402-0000-000000000000</id>
      <parentGroupId>d2383382-0158-1000-0000-000000000000</parentGroupId>
      <position>
        <x>312.76652507206836</x>
        <y>458.02800302957326</y>
      </position>
      <config>
        <bulletinLevel>WARN</bulletinLevel>
        <comments></comments>
        <concurrentlySchedulableTaskCount>1</concurrentlySchedulableTaskCount>
        <descriptors>
          <entry>
            <key>Script Engine</key>
            <value>
              <name>Script Engine</name>
            </value>
          </entry>
          <entry>
            <key>Script File</key>
            <value>
              <name>Script File</name>
            </value>
          </entry>
          <entry>
            <key>Script Body</key>
            <value>
              <name>Script Body</name>
            </value>
          </entry>
          <entry>
            <key>Module Directory</key>
            <value>
              <name>Module Directory</name>
            </value>
          </entry>
        </descriptors>
        <executionNode>ALL</executionNode>
        <lossTolerant>false</lossTolerant>
        <penaltyDuration>30 sec</penaltyDuration>
        <properties>
          <entry>
            <key>Script Engine</key>
            <value>python</value>
          </entry>
          <entry>
            <key>Script File</key>
          </entry>
          <entry>
            <key>Script Body</key>
            <value>
import java.io
from org.apache.commons.io import IOUtils

import re
import subprocess
import requests
import json
import time

# Get flowFile Session
flowFile = session.get()

# Open data.json file and parse json values
hostname = flowFile.getAttribute('host')


traceroute = subprocess.Popen(["traceroute",hostname],stdout=subprocess.PIPE, stderr=subprocess.STDOUT)

level = 0
for line in iter(traceroute.stdout.readline,""):
    time.sleep(1)
    try:
        ip_address    = re.findall('\(.*?\)',line)[0].replace('(','').replace(')','')
        response_time = re.findall('[0-9\.]+ ms',line)[0] 
        try:
            ipdata      = json.loads(requests.get('http://ip-api.com/json/' + ip_address).content)
            country     = str(ipdata['country']).strip()
            region      = str(ipdata['region']).strip()
            zipcode     = str(ipdata['zip']).strip()
            longitude   = str(ipdata['lon']).strip()
            latitude    = str(ipdata['lat']).strip()
            isp         = str(ipdata['isp']).strip()
            org         = str(ipdata['org']).strip()
            city        = str(ipdata['city']).strip()
        except:
            country     = ''
            region      = ''
            zipcode     = ''
            longitude   = ''
            latitude    = ''
            isp         = ''
            org         = ''
            city        = ''
        
        level += 1
        
        output = str(iteration) + '|' + str(level) + '|' + ip_address + '|' + response_time + '|' + country + '|' + region + '|' + city + '|' + longitude + '|' + latitude + '|' + isp + '|' + org + '\n'
    except:
        pass

traceroute.kill()


# Add/Put values to flowFile as new attributes
if (flowFile != None):
    flowFile = session.putAttribute(flowFile, "host", hostname)
    flowFile = session.putAttribute(flowFile, "level", str(level))
    flowFile = session.putAttribute(flowFile, "ip_address", ip_address)
    flowFile = session.putAttribute(flowFile, "response_time", response_time)
    flowFile = session.putAttribute(flowFile, "country", country)
    flowFile = session.putAttribute(flowFile, "region", region)
    flowFile = session.putAttribute(flowFile, "city", city)
    flowFile = session.putAttribute(flowFile, "longitude", longitude)
    flowFile = session.putAttribute(flowFile, "latitude", latitude)
    flowFile = session.putAttribute(flowFile, "isp", isp)
    flowFile = session.putAttribute(flowFile, "org", org)
    flowFile = session.putAttribute(flowFile, "output", output)

session.transfer(flowFile, REL_SUCCESS)
session.commit()

#ZEND</value>
          </entry>
          <entry>
            <key>Module Directory</key>
            <value>/Users/dzaratsian/anaconda/lib/python2.7/site-packages/</value>
          </entry>
        </properties>
        <runDurationMillis>0</runDurationMillis>
        <schedulingPeriod>0 sec</schedulingPeriod>
        <schedulingStrategy>TIMER_DRIVEN</schedulingStrategy>
        <yieldDuration>1 sec</yieldDuration>
      </config>
      <name>ExecuteScript</name>
      <relationships>
        <autoTerminate>false</autoTerminate>
        <name>failure</name>
      </relationships>
      <relationships>
        <autoTerminate>false</autoTerminate>
        <name>success</name>
      </relationships>
      <style></style>
      <type>org.apache.nifi.processors.script.ExecuteScript</type>
    </processors>
    <processors>
      <id>44023d4c-0157-1000-0000-000000000000</id>
      <parentGroupId>d2383382-0158-1000-0000-000000000000</parentGroupId>
      <position>
        <x>302.56135271530366</x>
        <y>236.94895083329163</y>
      </position>
      <config>
        <bulletinLevel>WARN</bulletinLevel>
        <comments></comments>
        <concurrentlySchedulableTaskCount>1</concurrentlySchedulableTaskCount>
        <descriptors>
          <entry>
            <key>Script Engine</key>
            <value>
              <name>Script Engine</name>
            </value>
          </entry>
          <entry>
            <key>Script File</key>
            <value>
              <name>Script File</name>
            </value>
          </entry>
          <entry>
            <key>Script Body</key>
            <value>
              <name>Script Body</name>
            </value>
          </entry>
          <entry>
            <key>Module Directory</key>
            <value>
              <name>Module Directory</name>
            </value>
          </entry>
        </descriptors>
        <executionNode>ALL</executionNode>
        <lossTolerant>false</lossTolerant>
        <penaltyDuration>30 sec</penaltyDuration>
        <properties>
          <entry>
            <key>Script Engine</key>
            <value>python</value>
          </entry>
          <entry>
            <key>Script File</key>
          </entry>
          <entry>
            <key>Script Body</key>
            <value>
from org.apache.commons.io import IOUtils
from java.nio.charset import StandardCharsets
from org.apache.nifi.processor.io import StreamCallback

import re,sys
import subprocess
import requests
import json
import time


class PyStreamCallback(StreamCallback):
  def __init__(self): pass
  def process(self, instream, outstream):
    # To read content as a byte array:
    # data = IOUtils.toByteArray(instream)
    
    # To read content as a string:
    data = IOUtils.toString(instream, StandardCharsets.UTF_8)
    hostname = json.loads(data)['hosts'][0]['host']
    
    traceroute = subprocess.Popen(["traceroute",hostname],stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    
    output = ''
    level  = 0
    for line in iter(traceroute.stdout.readline,""):
        time.sleep(1)
        try:
            ip_address    = re.findall('\(.*?\)',line)[0].replace('(','').replace(')','')
            response_time = re.findall('[0-9\.]+ ms',line)[0] 
            try:
                ipdata      = json.loads(requests.get('http://ip-api.com/json/' + ip_address).content)
                country     = str(ipdata['country']).strip()
                region      = str(ipdata['region']).strip()
                zipcode     = str(ipdata['zip']).strip()
                longitude   = str(ipdata['lon']).strip()
                latitude    = str(ipdata['lat']).strip()
                isp         = str(ipdata['isp']).strip()
                org         = str(ipdata['org']).strip()
                city        = str(ipdata['city']).strip()
            except:
                country     = ''
                region      = ''
                zipcode     = ''
                longitude   = ''
                latitude    = ''
                isp         = ''
                org         = ''
                city        = ''
            
            level += 1
            output = output + str(iteration) + '|' + str(level) + '|' + ip_address + '|' + response_time + '|' + country + '|' + region + '|' + city + '|' + longitude + '|' + latitude + '|' + isp + '|' + org + '\n'
        except:
            pass
    
    traceroute.kill()
    
    # Write modified content
    outstream.write(bytearray(output))


flowfile = session.get()
if (flowfile != None):
    # If you need to do something with attributes:
    # myVar = flowfile.getAttribute('filename')
    
    # To operate on content, setup a callback:
    flowfile = session.write(flowfile, PyStreamCallback())
    
    # Finish
    session.transfer(flowfile, REL_SUCCESS)

#ZEND</value>
          </entry>
          <entry>
            <key>Module Directory</key>
            <value>/Users/dzaratsian/anaconda/lib/python2.7/site-packages/</value>
          </entry>
        </properties>
        <runDurationMillis>0</runDurationMillis>
        <schedulingPeriod>0 sec</schedulingPeriod>
        <schedulingStrategy>TIMER_DRIVEN</schedulingStrategy>
        <yieldDuration>1 sec</yieldDuration>
      </config>
      <name>ExecuteScript</name>
      <relationships>
        <autoTerminate>false</autoTerminate>
        <name>failure</name>
      </relationships>
      <relationships>
        <autoTerminate>false</autoTerminate>
        <name>success</name>
      </relationships>
      <style></style>
      <type>org.apache.nifi.processors.script.ExecuteScript</type>
    </processors>
  </snippet>
  <timestamp>12/14/2016 12:05:38 EST</timestamp>
</template>